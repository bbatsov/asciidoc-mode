= asciidoc-mode
:url-repo: https://github.com/bbatsov/asciidoc-mode
:url-grammar: https://github.com/cathaysia/tree-sitter-asciidoc

image:https://melpa.org/packages/asciidoc-mode-badge.svg[MELPA,link="https://melpa.org/#/asciidoc-mode"]
image:https://stable.melpa.org/packages/asciidoc-mode-badge.svg[MELPA Stable,link="https://stable.melpa.org/#/asciidoc-mode"]
image:{url-repo}/actions/workflows/ci.yml/badge.svg[CI,link="{url-repo}/actions/workflows/ci.yml"]
image:https://img.shields.io/badge/license-GPL_3-green.svg[License GPL 3,link="https://www.gnu.org/copyleft/gpl.html"]

A tree-sitter-based major mode for editing https://asciidoc.org[AsciiDoc] files in Emacs.

== Features

* Syntax highlighting via tree-sitter (headings, inline markup, blocks, lists, admonitions, macros, attributes)
* Section navigation (`C-M-a` / `C-M-e`) and sentence-level movement (`M-a` / `M-e`) across paragraphs and blocks
* Imenu support for section navigation
* Outline minor mode enabled by default -- heading navigation (`C-c C-n/p/f/b/u`) and folding
* Comment support (`//` line comments)
* Graceful degradation -- works as basic `text-mode` when grammars are unavailable

== Rationale

I've been maintaining https://github.com/bbatsov/adoc-mode[adoc-mode] since 2022, but over time I realized I rarely used many of its advanced features (e.g. inline image preview, interactive markup commands, tempo templates, native code block highlighting). I wanted something simpler.

`asciidoc-mode` is my attempt to build a leaner alternative to `adoc-mode`, not a replacement for it. The key differences:

- Tree-sitter for robust, accurate font-locking and optimal performance in large documents
- Simple by design -- focuses on the essentials (highlighting, navigation, folding) without the bells and whistles
- Single-file implementation with minimal complexity

I named it `asciidoc-mode` instead of `adoc-ts-mode` because it shares nothing with `adoc-mode` and I wanted to emphasize that. There has never been an `asciidoc-mode` before, so `asciidoc-ts-mode` felt too verbose for no good reason.

`adoc-mode` will continue to be maintained and evolved separately. Pick whichever suits your workflow.

[cols="1,^1,^1", options="header"]
|===
| Feature | asciidoc-mode | adoc-mode

| Syntax highlighting
| Tree-sitter
| Regex

| Imenu
| Yes
| Yes

| Outline / folding
| Yes
| Yes

| Section navigation
| Yes
| No

| Sentence navigation
| Yes
| No

| Markup insertion commands
| No
| Yes

| Tempo templates
| No
| Yes

| Inline image preview
| No
| Yes

| Title promotion / demotion
| No
| Yes

| Native code block highlighting
| No
| Yes

| Flyspell integration
| No
| Yes

| Compilation error support
| No
| Yes

| Emacs requirement
| 30.1+
| 26.1+
|===

== Requirements

* Emacs 30.1 or later (built with tree-sitter support)
* Two tree-sitter grammars from {url-grammar}[cathaysia/tree-sitter-asciidoc]:
** `asciidoc` (block-level structure)
** `asciidoc_inline` (inline formatting)

== Installation

=== Grammar Setup

After installing the package, run:

[source,emacs-lisp]
----
M-x asciidoc-install-grammars
----

This downloads and compiles both grammars automatically. You only need to do this once.

=== Package Installation

==== MELPA

The package is available on https://melpa.org/#/asciidoc-mode[MELPA] and https://stable.melpa.org/#/asciidoc-mode[MELPA Stable]. If you've configured MELPA as a package source:

[source,emacs-lisp]
----
M-x package-install RET asciidoc-mode RET
----

Or with `use-package`:

[source,emacs-lisp]
----
(use-package asciidoc-mode
  :ensure t)
----

==== use-package with vc

Alternatively, Emacs 30+ can install directly from VCS:

[source,emacs-lisp]
----
(use-package asciidoc-mode
  :vc (:url "https://github.com/bbatsov/asciidoc-mode" :rev :newest :branch "main"))
----

==== Manual

Clone the repository and add it to your `load-path`:

[source,emacs-lisp]
----
(add-to-list 'load-path "/path/to/asciidoc-mode")
(require 'asciidoc-mode)
----

== Usage

Open any `.adoc` or `.asciidoc` file and `asciidoc-mode` activates automatically.

== Design

`asciidoc-mode` uses two tree-sitter parsers from {url-grammar}[cathaysia/tree-sitter-asciidoc], each covering the full buffer independently:

- `asciidoc` -- block-level structure (headings, paragraphs, lists, code blocks, admonitions, attributes, comments, etc.)
- `asciidoc-inline` -- inline formatting (bold, italic, monospace, links, cross-references, footnotes, macros, replacements, etc.)

The grammar author split them because block-level and inline-level parsing have fundamentally different rules in AsciiDoc, and separating them keeps each grammar simpler. Both parsers operate on the entire buffer without range restrictions -- this is the same dual-parser pattern used by Emacs's built-in `markdown-ts-mode`.

Because both parsers run independently on the same text, they can disagree. In particular, the inline parser misinterprets `*` and `**` list markers as emphasis delimiters, creating spurious emphasis spans that can swallow subsequent inline content (e.g. autolinks). To mitigate this, all block-level font-lock rules use `:override t` so that block-level faces (list markers, headings, code blocks, etc.) always win over incorrect inline faces. This doesn't fix inline elements consumed by the spurious emphasis nodes -- that requires an upstream grammar fix (see {url-repo}/issues/2[#2]).

A related subtlety: treesit's default font-lock behavior (`:override nil`) skips an entire captured range if _any_ position within it already has a face. This means font-lock rules that capture a broad parent node will silently fail when a child node was already fontified by an earlier rule. To avoid this, inline macro rules capture specific child nodes (`macro_name`, `target`) rather than the whole `inline_macro` node -- the same pattern used for block macros.

When grammars are unavailable, the mode falls back to plain `text-mode` with comment support only. No tree-sitter features are activated in this case.

== Development

The project uses https://emacs-eldev.github.io/eldev/[Eldev] for build tooling and https://github.com/jorgenschaefer/emacs-buttercup[Buttercup] for testing.

[source,shell]
----
# Install Eldev (if not already installed)
curl -fsSL https://raw.github.com/emacs-eldev/eldev/master/webinstall/eldev | sh

# Run everything
make all

# Individual targets
make compile   # Byte-compile with warnings-as-errors
make lint      # Run elisp-lint
make test      # Run buttercup tests
make clean     # Remove build artifacts
----

NOTE: Font-lock tests require the tree-sitter grammars to be installed. Tests that need grammars will be skipped (not failed) if they are unavailable.

== License

Licensed under the GNU General Public License v3.0 or later. See link:LICENSE[LICENSE] for details.
